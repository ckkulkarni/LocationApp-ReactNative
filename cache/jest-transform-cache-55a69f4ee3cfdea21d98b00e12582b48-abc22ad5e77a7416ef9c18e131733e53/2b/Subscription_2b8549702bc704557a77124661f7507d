8f6ac0d6959978eabf159c351aeeea49
"use strict";

exports.__esModule = true;
exports.createSubscription = createSubscription;
var _batch = require("./batch");
function createListenerCollection() {
  var batch = (0, _batch.getBatch)();
  var first = null;
  var last = null;
  return {
    clear: function clear() {
      first = null;
      last = null;
    },
    notify: function notify() {
      batch(function () {
        var listener = first;
        while (listener) {
          listener.callback();
          listener = listener.next;
        }
      });
    },
    get: function get() {
      var listeners = [];
      var listener = first;
      while (listener) {
        listeners.push(listener);
        listener = listener.next;
      }
      return listeners;
    },
    subscribe: function subscribe(callback) {
      var isSubscribed = true;
      var listener = last = {
        callback: callback,
        next: null,
        prev: last
      };
      if (listener.prev) {
        listener.prev.next = listener;
      } else {
        first = listener;
      }
      return function unsubscribe() {
        if (!isSubscribed || first === null) return;
        isSubscribed = false;
        if (listener.next) {
          listener.next.prev = listener.prev;
        } else {
          last = listener.prev;
        }
        if (listener.prev) {
          listener.prev.next = listener.next;
        } else {
          first = listener.next;
        }
      };
    }
  };
}
var nullListeners = {
  notify: function notify() {},
  get: function get() {
    return [];
  }
};
function createSubscription(store, parentSub) {
  var unsubscribe;
  var listeners = nullListeners;
  function addNestedSub(listener) {
    trySubscribe();
    return listeners.subscribe(listener);
  }
  function notifyNestedSubs() {
    listeners.notify();
  }
  function handleChangeWrapper() {
    if (subscription.onStateChange) {
      subscription.onStateChange();
    }
  }
  function isSubscribed() {
    return Boolean(unsubscribe);
  }
  function trySubscribe() {
    if (!unsubscribe) {
      unsubscribe = parentSub ? parentSub.addNestedSub(handleChangeWrapper) : store.subscribe(handleChangeWrapper);
      listeners = createListenerCollection();
    }
  }
  function tryUnsubscribe() {
    if (unsubscribe) {
      unsubscribe();
      unsubscribe = undefined;
      listeners.clear();
      listeners = nullListeners;
    }
  }
  var subscription = {
    addNestedSub: addNestedSub,
    notifyNestedSubs: notifyNestedSubs,
    handleChangeWrapper: handleChangeWrapper,
    isSubscribed: isSubscribed,
    trySubscribe: trySubscribe,
    tryUnsubscribe: tryUnsubscribe,
    getListeners: function getListeners() {
      return listeners;
    }
  };
  return subscription;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJleHBvcnRzIiwiX19lc01vZHVsZSIsImNyZWF0ZVN1YnNjcmlwdGlvbiIsIl9iYXRjaCIsInJlcXVpcmUiLCJjcmVhdGVMaXN0ZW5lckNvbGxlY3Rpb24iLCJiYXRjaCIsImdldEJhdGNoIiwiZmlyc3QiLCJsYXN0IiwiY2xlYXIiLCJub3RpZnkiLCJsaXN0ZW5lciIsImNhbGxiYWNrIiwibmV4dCIsImdldCIsImxpc3RlbmVycyIsInB1c2giLCJzdWJzY3JpYmUiLCJpc1N1YnNjcmliZWQiLCJwcmV2IiwidW5zdWJzY3JpYmUiLCJudWxsTGlzdGVuZXJzIiwic3RvcmUiLCJwYXJlbnRTdWIiLCJhZGROZXN0ZWRTdWIiLCJ0cnlTdWJzY3JpYmUiLCJub3RpZnlOZXN0ZWRTdWJzIiwiaGFuZGxlQ2hhbmdlV3JhcHBlciIsInN1YnNjcmlwdGlvbiIsIm9uU3RhdGVDaGFuZ2UiLCJCb29sZWFuIiwidHJ5VW5zdWJzY3JpYmUiLCJ1bmRlZmluZWQiLCJnZXRMaXN0ZW5lcnMiXSwic291cmNlcyI6WyJTdWJzY3JpcHRpb24uanMiXSwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmV4cG9ydHMuX19lc01vZHVsZSA9IHRydWU7XG5leHBvcnRzLmNyZWF0ZVN1YnNjcmlwdGlvbiA9IGNyZWF0ZVN1YnNjcmlwdGlvbjtcblxudmFyIF9iYXRjaCA9IHJlcXVpcmUoXCIuL2JhdGNoXCIpO1xuXG5mdW5jdGlvbiBjcmVhdGVMaXN0ZW5lckNvbGxlY3Rpb24oKSB7XG4gIGNvbnN0IGJhdGNoID0gKDAsIF9iYXRjaC5nZXRCYXRjaCkoKTtcbiAgbGV0IGZpcnN0ID0gbnVsbDtcbiAgbGV0IGxhc3QgPSBudWxsO1xuICByZXR1cm4ge1xuICAgIGNsZWFyKCkge1xuICAgICAgZmlyc3QgPSBudWxsO1xuICAgICAgbGFzdCA9IG51bGw7XG4gICAgfSxcblxuICAgIG5vdGlmeSgpIHtcbiAgICAgIGJhdGNoKCgpID0+IHtcbiAgICAgICAgbGV0IGxpc3RlbmVyID0gZmlyc3Q7XG5cbiAgICAgICAgd2hpbGUgKGxpc3RlbmVyKSB7XG4gICAgICAgICAgbGlzdGVuZXIuY2FsbGJhY2soKTtcbiAgICAgICAgICBsaXN0ZW5lciA9IGxpc3RlbmVyLm5leHQ7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0sXG5cbiAgICBnZXQoKSB7XG4gICAgICBsZXQgbGlzdGVuZXJzID0gW107XG4gICAgICBsZXQgbGlzdGVuZXIgPSBmaXJzdDtcblxuICAgICAgd2hpbGUgKGxpc3RlbmVyKSB7XG4gICAgICAgIGxpc3RlbmVycy5wdXNoKGxpc3RlbmVyKTtcbiAgICAgICAgbGlzdGVuZXIgPSBsaXN0ZW5lci5uZXh0O1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gbGlzdGVuZXJzO1xuICAgIH0sXG5cbiAgICBzdWJzY3JpYmUoY2FsbGJhY2spIHtcbiAgICAgIGxldCBpc1N1YnNjcmliZWQgPSB0cnVlO1xuICAgICAgbGV0IGxpc3RlbmVyID0gbGFzdCA9IHtcbiAgICAgICAgY2FsbGJhY2ssXG4gICAgICAgIG5leHQ6IG51bGwsXG4gICAgICAgIHByZXY6IGxhc3RcbiAgICAgIH07XG5cbiAgICAgIGlmIChsaXN0ZW5lci5wcmV2KSB7XG4gICAgICAgIGxpc3RlbmVyLnByZXYubmV4dCA9IGxpc3RlbmVyO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZmlyc3QgPSBsaXN0ZW5lcjtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGZ1bmN0aW9uIHVuc3Vic2NyaWJlKCkge1xuICAgICAgICBpZiAoIWlzU3Vic2NyaWJlZCB8fCBmaXJzdCA9PT0gbnVsbCkgcmV0dXJuO1xuICAgICAgICBpc1N1YnNjcmliZWQgPSBmYWxzZTtcblxuICAgICAgICBpZiAobGlzdGVuZXIubmV4dCkge1xuICAgICAgICAgIGxpc3RlbmVyLm5leHQucHJldiA9IGxpc3RlbmVyLnByZXY7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgbGFzdCA9IGxpc3RlbmVyLnByZXY7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAobGlzdGVuZXIucHJldikge1xuICAgICAgICAgIGxpc3RlbmVyLnByZXYubmV4dCA9IGxpc3RlbmVyLm5leHQ7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgZmlyc3QgPSBsaXN0ZW5lci5uZXh0O1xuICAgICAgICB9XG4gICAgICB9O1xuICAgIH1cblxuICB9O1xufVxuXG5jb25zdCBudWxsTGlzdGVuZXJzID0ge1xuICBub3RpZnkoKSB7fSxcblxuICBnZXQ6ICgpID0+IFtdXG59O1xuXG5mdW5jdGlvbiBjcmVhdGVTdWJzY3JpcHRpb24oc3RvcmUsIHBhcmVudFN1Yikge1xuICBsZXQgdW5zdWJzY3JpYmU7XG4gIGxldCBsaXN0ZW5lcnMgPSBudWxsTGlzdGVuZXJzO1xuXG4gIGZ1bmN0aW9uIGFkZE5lc3RlZFN1YihsaXN0ZW5lcikge1xuICAgIHRyeVN1YnNjcmliZSgpO1xuICAgIHJldHVybiBsaXN0ZW5lcnMuc3Vic2NyaWJlKGxpc3RlbmVyKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIG5vdGlmeU5lc3RlZFN1YnMoKSB7XG4gICAgbGlzdGVuZXJzLm5vdGlmeSgpO1xuICB9XG5cbiAgZnVuY3Rpb24gaGFuZGxlQ2hhbmdlV3JhcHBlcigpIHtcbiAgICBpZiAoc3Vic2NyaXB0aW9uLm9uU3RhdGVDaGFuZ2UpIHtcbiAgICAgIHN1YnNjcmlwdGlvbi5vblN0YXRlQ2hhbmdlKCk7XG4gICAgfVxuICB9XG5cbiAgZnVuY3Rpb24gaXNTdWJzY3JpYmVkKCkge1xuICAgIHJldHVybiBCb29sZWFuKHVuc3Vic2NyaWJlKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIHRyeVN1YnNjcmliZSgpIHtcbiAgICBpZiAoIXVuc3Vic2NyaWJlKSB7XG4gICAgICB1bnN1YnNjcmliZSA9IHBhcmVudFN1YiA/IHBhcmVudFN1Yi5hZGROZXN0ZWRTdWIoaGFuZGxlQ2hhbmdlV3JhcHBlcikgOiBzdG9yZS5zdWJzY3JpYmUoaGFuZGxlQ2hhbmdlV3JhcHBlcik7XG4gICAgICBsaXN0ZW5lcnMgPSBjcmVhdGVMaXN0ZW5lckNvbGxlY3Rpb24oKTtcbiAgICB9XG4gIH1cblxuICBmdW5jdGlvbiB0cnlVbnN1YnNjcmliZSgpIHtcbiAgICBpZiAodW5zdWJzY3JpYmUpIHtcbiAgICAgIHVuc3Vic2NyaWJlKCk7XG4gICAgICB1bnN1YnNjcmliZSA9IHVuZGVmaW5lZDtcbiAgICAgIGxpc3RlbmVycy5jbGVhcigpO1xuICAgICAgbGlzdGVuZXJzID0gbnVsbExpc3RlbmVycztcbiAgICB9XG4gIH1cblxuICBjb25zdCBzdWJzY3JpcHRpb24gPSB7XG4gICAgYWRkTmVzdGVkU3ViLFxuICAgIG5vdGlmeU5lc3RlZFN1YnMsXG4gICAgaGFuZGxlQ2hhbmdlV3JhcHBlcixcbiAgICBpc1N1YnNjcmliZWQsXG4gICAgdHJ5U3Vic2NyaWJlLFxuICAgIHRyeVVuc3Vic2NyaWJlLFxuICAgIGdldExpc3RlbmVyczogKCkgPT4gbGlzdGVuZXJzXG4gIH07XG4gIHJldHVybiBzdWJzY3JpcHRpb247XG59Il0sIm1hcHBpbmdzIjoiQUFBQSxZQUFZOztBQUVaQSxPQUFPLENBQUNDLFVBQVUsR0FBRyxJQUFJO0FBQ3pCRCxPQUFPLENBQUNFLGtCQUFrQixHQUFHQSxrQkFBa0I7QUFFL0MsSUFBSUMsTUFBTSxHQUFHQyxPQUFPLENBQUMsU0FBUyxDQUFDO0FBRS9CLFNBQVNDLHdCQUF3QkEsQ0FBQSxFQUFHO0VBQ2xDLElBQU1DLEtBQUssR0FBRyxDQUFDLENBQUMsRUFBRUgsTUFBTSxDQUFDSSxRQUFRLEdBQUc7RUFDcEMsSUFBSUMsS0FBSyxHQUFHLElBQUk7RUFDaEIsSUFBSUMsSUFBSSxHQUFHLElBQUk7RUFDZixPQUFPO0lBQ0xDLEtBQUssV0FBQUEsTUFBQSxFQUFHO01BQ05GLEtBQUssR0FBRyxJQUFJO01BQ1pDLElBQUksR0FBRyxJQUFJO0lBQ2IsQ0FBQztJQUVERSxNQUFNLFdBQUFBLE9BQUEsRUFBRztNQUNQTCxLQUFLLENBQUMsWUFBTTtRQUNWLElBQUlNLFFBQVEsR0FBR0osS0FBSztRQUVw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